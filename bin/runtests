#!/bin/bash
locate-dominating-dir () {
    path=$1
    while [[ "$path" != "" && ! -e "$path/$2" ]]; do
        path=${path%/*}
    done
    echo "$path"
}

realpath() {
    [[ $1 = /* ]] && echo "$1" || echo "$PWD/${1#./}"
}

filePath=$(realpath $1)

jestRootDir=$(locate-dominating-dir $filePath node_modules/.bin/jest)
mochaRootDir=$(locate-dominating-dir $filePath node_modules/.bin/mocha)

if [ -n "$jestRootDir" ]
then
    $(cd $jestRootDir && BLUEBIRD_DEBUG=yes $jestRootDir/node_modules/.bin/jest -b --colors $*)
elif [ -n "$mochaRootDir" ]
then
    $(cd $mochaRootDir && BLUEBIRD_DEBUG=yes $mochaRootDir/node_modules/.bin/mocha -b -R dot --colors $*)
fi

exitStatus=${PIPESTATUS[0]}
exit $exitStatus
